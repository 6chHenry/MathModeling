# Q4 网格实验组件文档

## 1. 组件概述

### 1.1 组件名称
GridExperimentAnalyzer（网格实验分析器）

### 1.2 主要功能
该组件提供全面的网格实验功能，用于评估电影院排片优化系统在不同参数配置、时间条件和紧急场景下的表现。主要功能包括：
- 关键参数（λ, α, ρ）的全面网格实验
- 一周滚动回测评估时间稳定性
- 紧急场景响应测试

### 1.3 应用场景
该组件适用于电影院排片优化系统的参数优化和性能评估，特别适用于：
- 排片策略参数优化
- 时间稳定性评估
- 紧急场景应对策略制定
- 运营决策支持

## 2. 技术架构

### 2.1 依赖库
- pandas: 数据处理和分析
- numpy: 数值计算
- matplotlib & seaborn: 数据可视化
- datetime: 时间处理
- warnings: 警告控制
- itertools: 参数组合生成

### 2.2 核心类结构
```python
class GridExperimentAnalyzer:
    def __init__(self, cinema_file, movies_file, historical_attendance_file=None)
    def parameter_grid_experiment(self)
    def rolling_backtest(self)
    def emergency_scenario_test(self)
    def generate_comprehensive_report(self)
    def run_full_analysis(self)
```

### 2.3 数据流程
1. 放映厅和电影数据加载
2. 时间段生成和参数初始化
3. 参数网格实验
4. 滚动回测分析
5. 紧急场景测试
6. 结果可视化与报告生成

## 3. 功能模块详解

### 3.1 数据初始化模块

#### 3.1.1 数据输入
- **放映厅数据**：包含放映厅信息（厅号、容量、支持的版本等）
- **电影数据**：包含电影信息（ID、时长、版本、基础票价、评分等）
- **历史上座率数据**：可选，用于更精确的上座率预测

#### 3.1.2 基础配置
- **营业时间**：10:00-03:00（次日）
- **时间段生成**：每15分钟一个时间点
- **版本成本系数**：2D(1.0), 3D(1.1), IMAX(1.15)
- **基础成本参数**：基本成本2.42元/人，固定成本90元

#### 3.1.3 关键参数
- **λ (lambda_param)**：收益权重，默认1.0
- **α (alpha_param)**：上座率权重，默认0.5
- **ρ (rho_param)**：多样性权重，默认0.3

### 3.2 参数网格实验模块

#### 3.2.1 搜索空间
- **lambda_range**：[0.5, 1.0, 1.5]
- **alpha_range**：[0.3, 0.5, 0.7]
- **rho_range**：[0.2, 0.3, 0.4]

#### 3.2.2 实验方法
1. 生成所有参数组合（共3×3×3=27种）
2. 对每种参数组合生成排片方案
3. 计算目标函数值和各项指标
4. 分析参数对性能的影响
5. 确定最优参数组合

#### 3.2.3 目标函数
```
目标函数 = λ × 总收益 + α × 总上座率 + ρ × 电影多样性
```

#### 3.2.4 评估指标
- 目标函数值
- 总收入
- 总上座率
- 电影多样性
- 平均利润

#### 3.2.5 输出结果
- 参数组合性能热力图
- 参数影响趋势图
- 最佳参数组合展示
- 结果保存为CSV和PNG格式

### 3.3 滚动回测模块

#### 3.3.1 回测设置
- **回测期间**：7天（可自定义）
- **起始日期**：默认2024-08-12（可自定义）
- **日期类型**：区分工作日和周末

#### 3.3.2 参数调整策略
- **周末**：λ=1.2, α=0.4（更注重收益）
- **工作日**：λ=0.8, α=0.6（更注重上座率）

#### 3.3.3 排片策略
- **周末**：选择高评分电影，增加黄金时段场次
- **工作日**：选择多样化电影，均衡分布时间段

#### 3.3.4 评估指标
- 总场次
- 总收益
- 总上座率
- 总利润
- 平均每场利润
- 黄金时段比例
- 电影多样性
- 上座率

#### 3.3.5 输出结果
- 每日收益趋势图
- 每日上座率趋势图
- 每日场次和电影多样性对比图
- 黄金时段比例和平均利润对比图
- 结果保存为CSV和PNG格式

### 3.4 紧急场景测试模块

#### 3.4.1 紧急场景定义
1. **高需求周末**：
   - 需求乘数：1.5
   - 价格乘数：1.2
   - 参数调整：λ=1.5, α=0.3

2. **设备故障**：
   - 可用放映厅：80%
   - 需求乘数：1.0
   - 价格乘数：1.0

3. **新片上映**：
   - 新增电影：2部
   - 需求乘数：1.3
   - 价格乘数：1.1
   - 参数调整：λ=1.2, α=0.4

4. **恶劣天气**：
   - 需求乘数：0.7
   - 价格乘数：0.9
   - 参数调整：λ=0.8, α=0.7

5. **竞争影院活动**：
   - 需求乘数：0.8
   - 价格乘数：0.85
   - 参数调整：λ=0.9, α=0.6

#### 3.4.2 测试方法
1. 生成基准排片方案
2. 对每个紧急场景生成相应排片方案
3. 计算场景相对于基准的变化
4. 评估系统对紧急场景的应对能力

#### 3.4.3 评估指标
- 收益变化率
- 上座率变化率
- 利润变化率
- 电影多样性变化率

#### 3.4.4 弹性评估
- **弹性评分**：100 - |利润变化率|
- **弹性等级**：
  - 高弹性：评分 > 80
  - 中等弹性：60 ≤ 评分 ≤ 80
  - 低弹性：评分 < 60

#### 3.4.5 输出结果
- 各场景对关键指标的影响柱状图
- 场景弹性评估结果
- 结果保存为CSV和PNG格式

### 3.5 综合分析模块

#### 3.5.1 关键发现分析
- 最佳参数组合识别
- 最稳定的一天识别
- 最具弹性场景识别
- 最缺乏弹性场景识别

#### 3.5.2 推荐系统
- **参数设置推荐**：基于网格实验结果
- **排片策略推荐**：基于滚动回测结果
- **紧急响应推荐**：基于紧急场景测试结果

#### 3.5.3 输出结果
- 综合分析报告（JSON格式）
- 包含所有测试结果的摘要
- 关键发现和具体建议

## 4. 使用方法

### 4.1 基本使用
```python
# 创建分析器实例
analyzer = GridExperimentAnalyzer(
    cinema_file='../input_data/df_cinema.csv',
    movies_file='../input_data/df_movies_schedule_ours.csv'
)

# 运行完整分析
results = analyzer.run_full_analysis()

# 查看结果
print(f"参数网格实验: {len(results['grid_results'])} 种参数组合")
print(f"滚动回测: {len(results['backtest_results'])} 天")
print(f"紧急场景测试: {len(results['emergency_results'])} 个场景")

# 查看最佳参数
best_params = results['report']['key_findings']['best_parameters']
if best_params:
    print(f"最佳参数: λ={best_params['lambda']}, α={best_params['alpha']}, ρ={best_params['rho']}")
```

### 4.2 单独使用各模块
```python
# 仅进行参数网格实验
grid_results = analyzer.parameter_grid_experiment()

# 仅进行滚动回测
backtest_results = analyzer.rolling_backtest()

# 仅进行紧急场景测试
emergency_results = analyzer.emergency_scenario_test()
```

### 4.3 自定义参数范围
```python
# 自定义参数范围
grid_results = analyzer.parameter_grid_experiment(
    lambda_range=[0.8, 1.0, 1.2],
    alpha_range=[0.4, 0.5, 0.6],
    rho_range=[0.25, 0.3, 0.35]
)

# 自定义回测期间
backtest_results = analyzer.rolling_backtest(
    start_date='2024-08-12',
    days=14
)
```

## 5. 输出文件说明

### 5.1 结果文件
- `parameter_grid_analysis.png`: 参数网格实验结果可视化
- `parameter_grid_results.csv`: 参数网格实验数据
- `rolling_backtest_analysis.png`: 滚动回测结果可视化
- `rolling_backtest_results.csv`: 滚动回测数据
- `emergency_scenario_analysis.png`: 紧急场景测试结果可视化
- `emergency_scenario_results.csv`: 紧急场景测试数据
- `grid_experiment_report.json`: 综合分析报告

### 5.2 文件格式说明
- PNG文件：可视化图表，300 DPI高清保存
- CSV文件：结构化数据，便于进一步分析
- JSON文件：综合报告，包含所有关键发现和建议

## 6. 参数配置

### 6.1 基础参数
- **营业时间**：10:00-03:00（次日）
- **时间段间隔**：15分钟
- **版本成本系数**：2D(1.0), 3D(1.1), IMAX(1.15)
- **基本成本**：2.42元/人
- **固定成本**：90元/场

### 6.2 关键参数默认值
- **λ (lambda_param)**：1.0（收益权重）
- **α (alpha_param)**：0.5（上座率权重）
- **ρ (rho_param)**：0.3（多样性权重）

### 6.3 实验参数
- **参数网格范围**：详见3.2.1节
- **回测天数**：7天
- **紧急场景**：详见3.4.1节

## 7. 性能考虑

### 7.1 计算复杂度
- 参数网格实验：O(n_lambda × n_alpha × n_rho × n_rooms × n_movies)
- 滚动回测：O(n_days × n_rooms × n_movies × n_time_slots)
- 紧急场景测试：O(n_scenarios × n_rooms × n_movies × n_time_slots)

### 7.2 优化建议
- 对于大规模放映厅和电影数据，可考虑减少参数网格密度
- 可并行化处理不同参数组合的实验
- 结果缓存机制可避免重复计算

## 8. 扩展性

### 8.1 自定义扩展
- 可添加新的参数进行网格实验
- 可扩展紧急场景类型
- 可集成其他评估指标和优化目标

### 8.2 集成建议
- 可作为排片优化系统的参数调优组件
- 可与运营决策支持系统集成
- 支持自动化参数优化和报告生成

## 9. 注意事项

### 9.1 使用限制
- 要求数据格式与预期一致
- 需要合理的放映厅和电影数据量
- 参数范围应根据实际业务场景调整

### 9.2 数据要求
- 输入数据应为CSV格式
- 放映厅数据必须包含：room、capacity、2D、3D、IMAX等字段
- 电影数据必须包含：id、runtime、version、basic_price、rating等字段
- 建议放映厅数量不少于3个，电影数量不少于5部

### 9.3 依赖环境
- Python 3.6+
- 所需依赖库版本见requirements.txt
- 建议使用虚拟环境管理依赖

## 10. 故障排除

### 10.1 常见问题
1. **数据加载失败**：检查文件路径和格式
2. **时间段生成错误**：确保营业时间设置合理
3. **票价计算错误**：检查电影基础价格和版本系数
4. **可视化错误**：确保matplotlib后端配置正确

### 10.2 调试建议
- 使用print语句跟踪执行流程
- 检查中间数据的维度和类型
- 验证参数范围的合理性
- 确保所有必需字段都存在

### 10.3 性能问题
- 减少参数网格的密度
- 优化回测天数和场景数量
- 考虑数据采样以提高处理速度

## 11. 结果解释指南

### 11.1 参数网格实验结果解释
- **热力图**：颜色越深表示目标函数值越高
- **参数影响**：观察参数变化对目标函数的影响趋势
- **最佳参数**：目标函数值最大的参数组合

### 11.2 滚动回测结果解释
- **收益趋势**：观察每日收益的波动情况
- **上座率趋势**：评估排片策略的稳定性
- **场次和多样性**：平衡收益和多样性
- **黄金时段比例**：优化黄金时段利用

### 11.3 紧急场景测试结果解释
- **变化率**：正值表示正面影响，负值表示负面影响
- **弹性评分**：评分越高，系统应对能力越强
- **场景对比**：识别系统最擅长和最不擅长应对的场景

### 11.4 综合报告解读
- **最佳参数**：推荐使用的参数组合
- **最稳定的一天**：可作为排片策略的参考模板
- **最具/最缺乏弹性场景**：指导紧急响应策略制定
- **建议**：基于实验结果的具体改进建议

## 12. 实际应用建议

### 12.1 参数优化策略
- 根据网格实验结果选择最佳参数组合
- 考虑不同时间段（周末/工作日）使用不同参数
- 定期重新评估参数以适应业务变化

### 12.2 排片策略优化
- 参考最稳定一天的排片策略
- 在周末增加高收益电影和黄金时段场次
- 保持电影多样性以提高整体吸引力

### 12.3 紧急响应预案
- 为高需求周末准备增加场次和提价方案
- 为设备故障准备厅场重分配方案
- 为新片上映准备快速调整排片计划
- 为恶劣天气准备降价和非黄金时段策略
- 为竞争活动准备特色场次和服务提升方案